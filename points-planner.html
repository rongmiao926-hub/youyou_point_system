<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ç§¯åˆ†ç³»ç»Ÿè®¾è®¡ä¸æ¨¡æ‹Ÿå°å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- æ ·å¼ -->
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }

    .container {
      max-width: 1100px;
      margin: 24px auto;
      padding: 16px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 24px;
      font-size: 14px;
    }

    .section {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.04);
    }

    .section h2 {
      font-size: 18px;
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section h2 span.badge {
      font-size: 12px;
      background: #eef2ff;
      color: #4f46e5;
      padding: 2px 8px;
      border-radius: 999px;
    }

    .section-desc {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    form.inline-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    input[type="text"],
    input[type="number"] {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      min-width: 0;
    }

    input[type="number"] {
      width: 110px;
    }

    input:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.2);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    button.primary {
      background: #4f46e5;
      color: #ffffff;
    }

    button.secondary {
      background: #e5e7eb;
      color: #374151;
    }

    button.danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 4px;
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #4b5563;
      background: #f9fafb;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .empty-tip {
      font-size: 12px;
      color: #9ca3af;
      padding: 4px 0;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #4b5563;
    }

    .calc-columns {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    @media (max-width: 768px) {
      .calc-columns {
        grid-template-columns: 1fr;
      }
    }

    .calc-section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .result-box {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      display: grid;
      gap: 4px;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
    }

    .result-label {
      color: #6b7280;
    }

    .result-value {
      font-weight: 600;
    }

    .result-balance.positive {
      color: #16a34a;
    }

    .result-balance.negative {
      color: #b91c1c;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfeff;
      color: #0e7490;
    }

    .footer-tip {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
    }
  </style>

  <!-- ç”¨äºå¯¼å‡º Excel çš„åº“ï¼ˆSheetJSï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <h1>ç§¯åˆ†ç³»ç»Ÿè®¾è®¡ä¸æ¨¡æ‹Ÿå°å·¥å…·</h1>
  <div class="subtitle">
    å…ˆé…ç½®ã€Œæ€ä¹ˆèµšåˆ†ã€ã€Œæ€ä¹ˆèŠ±åˆ†ã€ï¼Œå†ç”¨æ¨¡æ‹Ÿå™¨è¯•ç®—ä¸åŒè¡Œä¸ºæ¬¡æ•°ä¸‹ï¼Œæ€»ç§¯åˆ†å’Œå‰©ä½™ç§¯åˆ†æ˜¯å¤šå°‘ã€‚
  </div>

  <!-- èµšç§¯åˆ†å…¥å£ -->
  <section class="section" id="earn-section">
    <h2>
      1. èµšç§¯åˆ†çš„é€”å¾„
      <span class="badge">ç§¯åˆ†æ¥æºé…ç½®</span>
    </h2>
    <div class="section-desc">
      ä¾‹å¦‚ï¼šå®Œæˆæ–°æ‰‹ä»»åŠ¡ +100 åˆ†ã€æ¯æ—¥ç­¾åˆ° +10 åˆ†ã€å®Œæˆè®¢å• +5 åˆ†ç­‰ã€‚
    </div>
    <form class="inline-form" id="addEarnForm">
      <input type="text" id="earnName" placeholder="é€”å¾„åç§°ï¼ˆå¦‚ï¼šæ¯æ—¥ç­¾åˆ°ï¼‰" required />
      <input type="number" id="earnPoints" placeholder="æ¯æ¬¡è·å¾—ç§¯åˆ†" min="0" step="1" required />
      <button type="submit" class="primary">
        + æ·»åŠ èµšç§¯åˆ†é€”å¾„
      </button>
    </form>
    <div id="earnListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 45%;">é€”å¾„åç§°</th>
          <th style="width: 30%;">æ¯æ¬¡è·å¾—ç§¯åˆ†</th>
          <th style="width: 25%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="earnTableBody">
        <!-- åŠ¨æ€å¡«å…… -->
        </tbody>
      </table>
      <div id="earnEmptyTip" class="empty-tip">
        è¿˜æ²¡æœ‰é…ç½®èµšç§¯åˆ†æ–¹å¼ï¼Œå¯ä»¥å…ˆæ·»åŠ ä¸€ä¸¤æ¡ç¤ºä¾‹ã€‚
      </div>
    </div>
  </section>

  <!-- èŠ±ç§¯åˆ†å…¥å£ -->
  <section class="section" id="spend-section">
    <h2>
      2. èŠ±ç§¯åˆ†çš„é€”å¾„
      <span class="badge">ç§¯åˆ†æ¶ˆè€—é…ç½®</span>
    </h2>
    <div class="section-desc">
      ä¾‹å¦‚ï¼šå…‘æ¢ä¼˜æƒ åˆ¸ -100 åˆ†ã€æŠ½å¥–ä¸€æ¬¡ -20 åˆ†ã€è§£é”ä¼šå‘˜æƒç›Š -500 åˆ†ç­‰ã€‚
    </div>
    <form class="inline-form" id="addSpendForm">
      <input type="text" id="spendName" placeholder="é€”å¾„åç§°ï¼ˆå¦‚ï¼šå…‘æ¢5å…ƒåˆ¸ï¼‰" required />
      <input type="number" id="spendPoints" placeholder="æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†" min="0" step="1" required />
      <button type="submit" class="primary">
        + æ·»åŠ èŠ±ç§¯åˆ†é€”å¾„
      </button>
    </form>
    <div id="spendListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 45%;">é€”å¾„åç§°</th>
          <th style="width: 30%;">æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†</th>
          <th style="width: 25%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="spendTableBody">
        <!-- åŠ¨æ€å¡«å…… -->
        </tbody>
      </table>
      <div id="spendEmptyTip" class="empty-tip">
        è¿˜æ²¡æœ‰é…ç½®èŠ±ç§¯åˆ†æ–¹å¼ï¼Œå¯ä»¥å…ˆæ·»åŠ ä¸€ä¸¤æ¡ç¤ºä¾‹ã€‚
      </div>
    </div>
  </section>

  <!-- æ¨¡æ‹Ÿè®¡ç®—å…¥å£ -->
  <section class="section" id="calc-section">
    <h2>
      3. ç§¯åˆ†æ¨¡æ‹Ÿè®¡ç®—
      <span class="badge">ä½¿ç”¨æ¬¡æ•° â†’ å‰©ä½™ç§¯åˆ†</span>
    </h2>
    <div class="section-desc">
      ç¬¬ä¸€æ­¥ï¼šå¡«å†™æ¯ç§ã€Œèµšç§¯åˆ†ã€é€”å¾„çš„ä½¿ç”¨æ¬¡æ•°ï¼Œç®—å‡ºæ€»å…±èµšäº†å¤šå°‘åˆ†ã€‚<br>
      ç¬¬äºŒæ­¥ï¼šå¡«å†™æ¯ç§ã€ŒèŠ±ç§¯åˆ†ã€é€”å¾„çš„ä½¿ç”¨æ¬¡æ•°ï¼Œçœ‹èŠ±æ‰å¤šå°‘åˆ†ï¼Œä»¥åŠæœ€ç»ˆè¿˜å‰©å¤šå°‘ã€‚
    </div>

    <div class="calc-columns">
      <!-- èµšç§¯åˆ†æ¨¡æ‹Ÿ -->
      <div>
        <div class="calc-section-title">
          <strong>èµšç§¯åˆ†æ¬¡æ•°</strong>
          <span class="tag">ä»ä¸Šé¢çš„æ¥æºåˆ—è¡¨è‡ªåŠ¨ç”Ÿæˆ</span>
        </div>
        <table>
          <thead>
          <tr>
            <th>é€”å¾„</th>
            <th>æ¯æ¬¡ç§¯åˆ†</th>
            <th>ä½¿ç”¨æ¬¡æ•°</th>
            <th>å°è®¡</th>
          </tr>
          </thead>
          <tbody id="earnCalcBody">
          <!-- åŠ¨æ€å¡«å…… -->
          </tbody>
        </table>
        <div id="earnCalcEmptyTip" class="empty-tip">
          æš‚æ— èµšç§¯åˆ†é…ç½®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹æ·»åŠ ã€Œèµšç§¯åˆ†çš„é€”å¾„ã€ã€‚
        </div>
      </div>

      <!-- èŠ±ç§¯åˆ†æ¨¡æ‹Ÿ -->
      <div>
        <div class="calc-section-title">
          <strong>èŠ±ç§¯åˆ†æ¬¡æ•°</strong>
          <span class="tag">ä»ä¸Šé¢çš„æ¶ˆè€—åˆ—è¡¨è‡ªåŠ¨ç”Ÿæˆ</span>
        </div>
        <table>
          <thead>
          <tr>
            <th>é€”å¾„</th>
            <th>æ¯æ¬¡èŠ±è´¹</th>
            <th>ä½¿ç”¨æ¬¡æ•°</th>
            <th>å°è®¡</th>
          </tr>
          </thead>
          <tbody id="spendCalcBody">
          <!-- åŠ¨æ€å¡«å…… -->
          </tbody>
        </table>
        <div id="spendCalcEmptyTip" class="empty-tip">
          æš‚æ— èŠ±ç§¯åˆ†é…ç½®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹æ·»åŠ ã€ŒèŠ±ç§¯åˆ†çš„é€”å¾„ã€ã€‚
        </div>
      </div>
    </div>

    <div style="margin-top: 12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="calcButton" class="primary">
        ğŸ§® è®¡ç®—ç§¯åˆ†
      </button>
      <button id="resetCountsButton" class="secondary">
        æ¸…ç©ºæ‰€æœ‰æ¬¡æ•°
      </button>
    </div>

    <div class="result-box">
      <div class="result-row">
        <span class="result-label">æ€»å…±è·å¾—ç§¯åˆ†ï¼š</span>
        <span class="result-value" id="totalEarned">0</span>
      </div>
      <div class="result-row">
        <span class="result-label">æ€»å…±èŠ±è´¹ç§¯åˆ†ï¼š</span>
        <span class="result-value" id="totalSpent">0</span>
      </div>
      <div class="result-row">
        <span class="result-label">å‰©ä½™ç§¯åˆ†ï¼š</span>
        <span class="result-value result-balance" id="balance">0</span>
      </div>
    </div>

    <div class="footer-tip">
      å°æç¤ºï¼šä½ å¯ä»¥éšæ„ä¿®æ”¹ä¸Šé¢çš„é…ç½®ï¼Œå¤šè¯•å‡ å¥—ã€Œèµš / èŠ±ã€æ–¹æ¡ˆï¼Œçœ‹ä¸åŒè®¾è®¡ä¸‹ç”¨æˆ·å¤§æ¦‚èƒ½æ”’å¤šå°‘ç§¯åˆ†ã€å¤šä¹…èƒ½å…‘å‡ºå¤§ä»¶ã€‚
    </div>

    <!-- ä¿å­˜ / è½½å…¥ / å¯¼å‡ºæŒ‰é’® -->
    <div style="margin-top: 10px; display:flex; flex-wrap:wrap; gap:8px;">
      <button id="saveConfigButton" class="secondary">ğŸ’¾ ä¿å­˜å½“å‰ç§¯åˆ†è§„åˆ™</button>
      <button id="loadConfigButton" class="secondary">ğŸ“‚ è½½å…¥å·²ä¿å­˜è§„åˆ™</button>
      <button id="clearConfigButton" class="secondary">ğŸ§¹ æ¸…é™¤æœ¬åœ°ä¿å­˜</button>
      <button id="exportXlsxButton" class="secondary">ğŸ“‘ å¯¼å‡ºè§„åˆ™ä¸º Excel</button>
    </div>
  </section>
</div>

<script>
  // ====== å…¨å±€æ•°æ® ======
  let earnActions = [];
  let spendActions = [];
  let nextId = 1;
  const STORAGE_KEY = "points-config-v1";

  const earnTableBody = document.getElementById("earnTableBody");
  const spendTableBody = document.getElementById("spendTableBody");
  const earnEmptyTip = document.getElementById("earnEmptyTip");
  const spendEmptyTip = document.getElementById("spendEmptyTip");

  const earnCalcBody = document.getElementById("earnCalcBody");
  const spendCalcBody = document.getElementById("spendCalcBody");
  const earnCalcEmptyTip = document.getElementById("earnCalcEmptyTip");
  const spendCalcEmptyTip = document.getElementById("spendCalcEmptyTip");

  const totalEarnedSpan = document.getElementById("totalEarned");
  const totalSpentSpan = document.getElementById("totalSpent");
  const balanceSpan = document.getElementById("balance");

  // ====== æ¸²æŸ“åˆ—è¡¨ï¼šèµšç§¯åˆ†ï¼ˆå¸¦å¯ç¼–è¾‘æ•°å­—æ¡†ï¼‰ ======
  function renderEarnActions() {
    earnTableBody.innerHTML = "";
    if (earnActions.length === 0) {
      earnEmptyTip.style.display = "block";
    } else {
      earnEmptyTip.style.display = "block";
      earnEmptyTip.textContent = "æç¤ºï¼šä½ å¯ä»¥ç»§ç»­æ·»åŠ ï¼Œä¹Ÿå¯ä»¥åˆ é™¤ä¸éœ€è¦çš„é€”å¾„ã€‚";
    }

    earnActions.forEach(action => {
      const tr = document.createElement("tr");

      // é€”å¾„åç§°
      const nameTd = document.createElement("td");
      nameTd.textContent = action.name;
      tr.appendChild(nameTd);

      // æ¯æ¬¡è·å¾—ç§¯åˆ† â€”â€” æ”¹æˆ input
      const pointsTd = document.createElement("td");
      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = action.points;
      input.style.width = "80px";

      input.addEventListener("change", () => {
        const newVal = Number(input.value);
        action.points = isNaN(newVal) || newVal < 0 ? 0 : newVal;
        input.value = action.points;
        renderCalcTables(); // æ›´æ–°æ¨¡æ‹ŸåŒºå±•ç¤ºçš„ç§¯åˆ†å€¼
      });

      pointsTd.appendChild(input);
      const unitSpan = document.createElement("span");
      unitSpan.textContent = " åˆ†";
      unitSpan.style.marginLeft = "4px";
      pointsTd.appendChild(unitSpan);
      tr.appendChild(pointsTd);

      // æ“ä½œåˆ—ï¼šåˆ é™¤
      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ é™¤";
      delBtn.className = "danger";
      delBtn.addEventListener("click", () => {
        earnActions = earnActions.filter(a => a.id !== action.id);
        renderEarnActions();
        renderCalcTables();
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      earnTableBody.appendChild(tr);
    });
  }

  // ====== æ¸²æŸ“åˆ—è¡¨ï¼šèŠ±ç§¯åˆ†ï¼ˆå¸¦å¯ç¼–è¾‘æ•°å­—æ¡†ï¼‰ ======
  function renderSpendActions() {
    spendTableBody.innerHTML = "";
    if (spendActions.length === 0) {
      spendEmptyTip.style.display = "block";
    } else {
      spendEmptyTip.style.display = "block";
      spendEmptyTip.textContent = "æç¤ºï¼šä½ å¯ä»¥ç»§ç»­æ·»åŠ ï¼Œä¹Ÿå¯ä»¥åˆ é™¤ä¸éœ€è¦çš„é€”å¾„ã€‚";
    }

    spendActions.forEach(action => {
      const tr = document.createElement("tr");

      // é€”å¾„åç§°
      const nameTd = document.createElement("td");
      nameTd.textContent = action.name;
      tr.appendChild(nameTd);

      // æ¯æ¬¡æ¶ˆè€—ç§¯åˆ† â€”â€” æ”¹æˆ input
      const pointsTd = document.createElement("td");
      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = action.points;
      input.style.width = "80px";

      input.addEventListener("change", () => {
        const newVal = Number(input.value);
        action.points = isNaN(newVal) || newVal < 0 ? 0 : newVal;
        input.value = action.points;
        renderCalcTables();
      });

      pointsTd.appendChild(input);
      const unitSpan = document.createElement("span");
      unitSpan.textContent = " åˆ†";
      unitSpan.style.marginLeft = "4px";
      pointsTd.appendChild(unitSpan);
      tr.appendChild(pointsTd);

      // æ“ä½œåˆ—ï¼šåˆ é™¤
      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ é™¤";
      delBtn.className = "danger";
      delBtn.addEventListener("click", () => {
        spendActions = spendActions.filter(a => a.id !== action.id);
        renderSpendActions();
        renderCalcTables();
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      spendTableBody.appendChild(tr);
    });
  }

  // ====== æ¨¡æ‹ŸåŒºåŸŸè¡¨æ ¼ ======
  function renderCalcTables() {
    // èµšç§¯åˆ†
    earnCalcBody.innerHTML = "";
    if (earnActions.length === 0) {
      earnCalcEmptyTip.style.display = "block";
    } else {
      earnCalcEmptyTip.style.display = "none";
      earnActions.forEach(action => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = action.name;
        tr.appendChild(nameTd);

        const pointsTd = document.createElement("td");
        pointsTd.textContent = action.points;
        tr.appendChild(pointsTd);

        const countTd = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = "0";
        input.dataset.actionId = action.id;
        input.className = "earn-count-input";
        input.style.width = "80px";
        countTd.appendChild(input);
        tr.appendChild(countTd);

        const subtotalTd = document.createElement("td");
        subtotalTd.textContent = "0";
        subtotalTd.dataset.actionId = action.id;
        subtotalTd.className = "earn-subtotal";
        tr.appendChild(subtotalTd);

        earnCalcBody.appendChild(tr);
      });
    }

    // èŠ±ç§¯åˆ†
    spendCalcBody.innerHTML = "";
    if (spendActions.length === 0) {
      spendCalcEmptyTip.style.display = "block";
    } else {
      spendCalcEmptyTip.style.display = "none";
      spendActions.forEach(action => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = action.name;
        tr.appendChild(nameTd);

        const pointsTd = document.createElement("td");
        pointsTd.textContent = action.points;
        tr.appendChild(pointsTd);

        const countTd = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = "0";
        input.dataset.actionId = action.id;
        input.className = "spend-count-input";
        input.style.width = "80px";
        countTd.appendChild(input);
        tr.appendChild(countTd);

        const subtotalTd = document.createElement("td");
        subtotalTd.textContent = "0";
        subtotalTd.dataset.actionId = action.id;
        subtotalTd.className = "spend-subtotal";
        tr.appendChild(subtotalTd);

        spendCalcBody.appendChild(tr);
      });
    }
  }

  // ====== è®¡ç®—ç§¯åˆ† ======
  function calculatePoints() {
    let totalEarned = 0;
    let totalSpent = 0;

    // èµšç§¯åˆ†
    const earnInputs = document.querySelectorAll(".earn-count-input");
    earnInputs.forEach(input => {
      const id = parseInt(input.dataset.actionId, 10);
      const action = earnActions.find(a => a.id === id);
      if (!action) return;
      const count = Number(input.value) || 0;
      const subtotal = count * action.points;
      totalEarned += subtotal;

      const subtotalTd = document.querySelector(
        '.earn-subtotal[data-action-id="' + id + '"]'
      );
      if (subtotalTd) subtotalTd.textContent = subtotal;
    });

    // èŠ±ç§¯åˆ†
    const spendInputs = document.querySelectorAll(".spend-count-input");
    spendInputs.forEach(input => {
      const id = parseInt(input.dataset.actionId, 10);
      const action = spendActions.find(a => a.id === id);
      if (!action) return;
      const count = Number(input.value) || 0;
      const subtotal = count * action.points;
      totalSpent += subtotal;

      const subtotalTd = document.querySelector(
        '.spend-subtotal[data-action-id="' + id + '"]'
      );
      if (subtotalTd) subtotalTd.textContent = subtotal;
    });

    const balance = totalEarned - totalSpent;
    totalEarnedSpan.textContent = totalEarned;
    totalSpentSpan.textContent = totalSpent;
    balanceSpan.textContent = balance;

    balanceSpan.classList.remove("positive", "negative");
    if (balance > 0) balanceSpan.classList.add("positive");
    else if (balance < 0) balanceSpan.classList.add("negative");
  }

  function resetAllCounts() {
    document
      .querySelectorAll(".earn-count-input, .spend-count-input")
      .forEach(input => {
        input.value = "0";
      });
    document
      .querySelectorAll(".earn-subtotal, .spend-subtotal")
      .forEach(td => {
        td.textContent = "0";
      });
    totalEarnedSpan.textContent = "0";
    totalSpentSpan.textContent = "0";
    balanceSpan.textContent = "0";
    balanceSpan.classList.remove("positive", "negative");
  }

  // ====== æœ¬åœ°ä¿å­˜é€»è¾‘ ======
  function recomputeNextId() {
    const all = [...earnActions, ...spendActions];
    if (all.length === 0) nextId = 1;
    else nextId = Math.max(...all.map(a => a.id || 0)) + 1;
  }

  function saveConfig() {
    const data = { earnActions, spendActions, nextId };
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      alert("å·²ä¿å­˜åˆ°æœ¬æµè§ˆå™¨ï¼ˆåŒä¸€å°è®¾å¤‡ã€åŒä¸€æµè§ˆå™¨ä¸‹ä¼šä¿ç•™ï¼‰");
    } catch (e) {
      console.error(e);
      alert("ä¿å­˜å¤±è´¥ï¼šå¯èƒ½æ˜¯æµè§ˆå™¨ç¦æ­¢äº†æœ¬åœ°å­˜å‚¨ã€‚");
    }
  }

  function loadConfig(showAlert = true) {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      if (showAlert) alert("æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰ä¿å­˜çš„ç§¯åˆ†è§„åˆ™ã€‚");
      return false;
    }
    try {
      const data = JSON.parse(raw);
      earnActions = Array.isArray(data.earnActions) ? data.earnActions : [];
      spendActions = Array.isArray(data.spendActions) ? data.spendActions : [];
      nextId = typeof data.nextId === "number" ? data.nextId : 1;
      recomputeNextId();

      renderEarnActions();
      renderSpendActions();
      renderCalcTables();
      resetAllCounts();

      if (showAlert) alert("å·²è½½å…¥æœ¬åœ°ä¿å­˜çš„ç§¯åˆ†è§„åˆ™ã€‚");
      return true;
    } catch (e) {
      console.error(e);
      if (showAlert) alert("ä¿å­˜çš„æ•°æ®å·²æŸåï¼Œæ— æ³•è¯»å–ã€‚");
      return false;
    }
  }

  function clearConfig() {
    localStorage.removeItem(STORAGE_KEY);
    alert("å·²æ¸…é™¤æœ¬åœ°ä¿å­˜ã€‚å½“å‰é¡µé¢ä¸Šçš„å†…å®¹ä¸å—å½±å“ã€‚");
  }

  // ====== å¯¼å‡ºä¸º Excelï¼ˆxlsxï¼‰ ======
  function exportConfigToXlsx() {
    if (typeof XLSX === "undefined") {
      alert("å½“å‰ç¯å¢ƒæ— æ³•ä½¿ç”¨ Excel å¯¼å‡ºåŠŸèƒ½ã€‚");
      return;
    }

    const wb = XLSX.utils.book_new();

    // sheet1ï¼šèµšç§¯åˆ†è§„åˆ™
    const earnData = [["ç±»å‹", "é€”å¾„åç§°", "æ¯æ¬¡ç§¯åˆ†"]];
    earnActions.forEach(a => {
      earnData.push(["èµšç§¯åˆ†", a.name, a.points]);
    });
    const earnSheet = XLSX.utils.aoa_to_sheet(earnData);
    XLSX.utils.book_append_sheet(wb, earnSheet, "EarnRules");

    // sheet2ï¼šèŠ±ç§¯åˆ†è§„åˆ™
    const spendData = [["ç±»å‹", "é€”å¾„åç§°", "æ¯æ¬¡ç§¯åˆ†"]];
    spendActions.forEach(a => {
      spendData.push(["èŠ±ç§¯åˆ†", a.name, a.points]);
    });
    const spendSheet = XLSX.utils.aoa_to_sheet(spendData);
    XLSX.utils.book_append_sheet(wb, spendSheet, "SpendRules");

    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    const fileName = `ç§¯åˆ†è§„åˆ™_${y}${m}${d}.xlsx`;

    XLSX.writeFile(wb, fileName);
  }

  // ====== äº‹ä»¶ç»‘å®š ======
  document.getElementById("addEarnForm").addEventListener("submit", e => {
    e.preventDefault();
    const nameInput = document.getElementById("earnName");
    const pointsInput = document.getElementById("earnPoints");
    const name = nameInput.value.trim();
    const points = Number(pointsInput.value);

    if (!name) return;
    if (isNaN(points) || points < 0) return;

    earnActions.push({ id: nextId++, name, points });
    nameInput.value = "";
    pointsInput.value = "";
    renderEarnActions();
    renderCalcTables();
  });

  document.getElementById("addSpendForm").addEventListener("submit", e => {
    e.preventDefault();
    const nameInput = document.getElementById("spendName");
    const pointsInput = document.getElementById("spendPoints");
    const name = nameInput.value.trim();
    const points = Number(pointsInput.value);

    if (!name) return;
    if (isNaN(points) || points < 0) return;

    spendActions.push({ id: nextId++, name, points });
    nameInput.value = "";
    pointsInput.value = "";
    renderSpendActions();
    renderCalcTables();
  });

  document.getElementById("calcButton").addEventListener("click", calculatePoints);
  document.getElementById("resetCountsButton").addEventListener("click", resetAllCounts);

  document.getElementById("saveConfigButton").addEventListener("click", saveConfig);
  document.getElementById("loadConfigButton").addEventListener("click", () => loadConfig(true));
  document.getElementById("clearConfigButton").addEventListener("click", clearConfig);
  document.getElementById("exportXlsxButton").addEventListener("click", exportConfigToXlsx);

  // ====== åˆå§‹åŒ–ï¼šä¼˜å…ˆè½½å…¥æœ¬åœ°ä¿å­˜ï¼›æ²¡æœ‰åˆ™ä½¿ç”¨ç¤ºä¾‹ ======
  function initExamples() {
    earnActions = [
      { id: nextId++, name: "å®Œæˆæ–°æ‰‹ä»»åŠ¡", points: 100 },
      { id: nextId++, name: "æ¯æ—¥ç­¾åˆ°", points: 10 },
      { id: nextId++, name: "å®Œæˆä¸€æ¬¡è®¢å•", points: 5 }
    ];
    spendActions = [
      { id: nextId++, name: "å…‘æ¢5å…ƒä¼˜æƒ åˆ¸", points: 100 },
      { id: nextId++, name: "ç§¯åˆ†æŠ½å¥–ä¸€æ¬¡", points: 20 },
      { id: nextId++, name: "è§£é”ä¼šå‘˜ä¸€å‘¨", points: 300 }
    ];

    renderEarnActions();
    renderSpendActions();
    renderCalcTables();
  }

  function init() {
    const loaded = loadConfig(false);
    if (!loaded) initExamples();
  }

  init();
</script>
</body>
</html>
